Hello this is aiksu.


这是我对第一个靶场的wp，也是我的毕业设计，我将详细记录做题的过程以及心得

测试环境：

Windows7
Apache2.2.25 (Win32) 
mod_ssl2.2.25 
OpenSSL0.9.8y 
PHP5.2.17

仓库链接
https://github.com/c0ny1/upload-labs
https://github.com/c0ny1/upload-labs/releases windows一键部署版

###############################################
PASS-01--前端js验证
###############################################
检测方法：
前端验证选择文件是否为允许的文件，不是允许的文件则提示错误

绕过方法：
1.浏览器关闭JavaScript
2.修改文件后缀名

################################################
PASS-02--MIME检测
################################################
判断方法：
检测Content-Type的内容。是否为允许的内容

绕过方法：
Burpsuit将上传数据包类型修改为允许上传的类型即可。

################################################
PASS-03--黑名单检测
################################################
判断方法：
后端检测上传的文件后缀名是否在黑名单中。
可以用php2 php3 php5 php7 phtml

实测php3可以,改名字或者伪造名字不行

php3也更改名字了


绕过方法：
审计代码，修改文件后缀名。

################################################
PASS-04--.htaccess绕过-success
################################################
判断方法：
后端检测上传的文件后缀名是否在黑名单中，审计代码发现.htaccess文件不在黑名单中，可以上传这个文件，服务器会按照这个规则将上传的文件解析为php文件执行。

绕过方法：
上传.htaccess文件，内容为：
AddType application/x-httpd-php .jpg
AddType application/x-httpd-php .png
AddType application/x-httpd-php .gif

################################################
PASS-05--通过. .(点空格点)绕过
################################################

判断方法：
后端检测，但是Windows系统会自动删除一个点

绕过方法，再Burpsuite中将上传数据包文件名后面加上. .(点空格点)即可

浏览器预览图片会跳转到php.  删除.后就欧克了
windows会将文件末尾的.删除

################################################
PASS-06--通过大小写绕过
################################################
本关禁止上传.htaccess .user.ini
没有禁止phP 、Php 所以将文件名字大小写就绕过了限制

改名后缀.pHP

################################################
PASS-07--空格绕过黑名单
################################################
审计代码发现 缺少了首尾去除空格的代码过滤
利用PHP 和 Windows环境的叠加特性 windows系统自动删除文件名后缀的空格 绕过黑名单

加一个空格就好

会重命名文件-比较麻烦-得调用


################################################
PASS-08--点绕过黑名单
################################################
阅读代码发现缺少了deldot函数 删除文件名最后一个点(如果有多个连续的… 会全部删除)
利用Windows系统保存文件的特性 会删除文件后缀名的xxx.php. 最后上传的文件还是xxx.php

加一个点就好


################################################
Pass-09（::$DATA绕过黑名单）
################################################

这一关黑名单，没有对::D A T A 进行处理使用 : : DATA 进 行 处 理 使用::DATA进行处理使用::DATA 进行处理，可以使用::$DATA绕过黑名单





################################################
Pass-10（点空格点黑名单）
################################################

可以尝试 Apache的未知后缀名解析漏洞 和 4.php:.jpg 即第四关的思路二、三


################################################
Pass-11（双写php绕过黑名单）
################################################
用上传的文件名来拼接路径并保存文件 没有对文件重命名


################################################
Pass-12（%00截断白名单）
################################################

本pass上传路径可控！

代码漏洞点就在于 用$_GET[‘save_path’]来组成上传的文件路径 而这个get传参是我们可以控制的地方

因此我们考虑用是否能进行截断 例如形成…/upload/12.php/截断后面的(xxx.jpg)

这样就通过了白名单校验 并且保存成了php文件

审计代码，发现文件保存为12.php




################################################
Pass-13（0x00截断白名单）
################################################

同第12关做法相同 只不过上传路径在$_POST数据中 不需要url编码

这里说一个小技巧 不需要修改hex值那么麻烦 只要在burp里面输入%00 然后进行url解码即可 得到就是0x00


################################################
Pass-14（文件包含+图片马）
################################################
审计代码，大致意思就是读取文件头的两字节 将二进制数据转换为ASCII值 进行switch比较 也就是说只验证文件头信息
将图片嵌入木马

服务器通过读取前面的字节码，重命名文件


通过上传图片马，服务器会将图片马的文件名重命名为php文件

我们需要使用文件包含漏洞利用


################################################
Pass-15（文件包含+图片马）
################################################
同第14关

阅读代码 这里只讲解主要函数 其余代码都差不多

getimagesize()函数：

返回一个具有四个单元的数组。

索引 0 包含图像宽度的像素值，

索引 1 包含图像高度的像素值。

索引 2 是图像类型的标记 ：1 = GIF，2 = JPG，3 = PNG，4 = SWF，5 = PSD，6 = BMP，7 =
TIFF(intel byte order)，8 = TIFF(motorola byte order)，9 = JPC，10 = JP2，11 =
JPX，12 = JB2，13 = SWC，14 = IFF，15 = WBMP，16 = XBM。这些标记与 PHP 4.3.0 新加的
IMAGETYPE 常量对应。

索引 3 是文本字符串，内容为"height=“yyy” width=“xxx”"，可直接用于 IMG 标记。

################################################
Pass-16（文件包含+图片马）
################################################
没啥区别 只是换了函数 需要开启php_exif模块。

做法和第14关相同


################################################
Pass-17（二次渲染+图片马/条件竞争）
################################################







################################################
Pass-18（二次渲染+图片马/条件竞争）
################################################
